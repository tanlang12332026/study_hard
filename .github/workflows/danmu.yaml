name: 弹幕

on:

  workflow_dispatch:
    inputs:
      reason:
        description: '触发原因'
        default: '手动 调用'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  danmu:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout 代码
        uses: actions/checkout@v4

      # --- 优化点 1: 配置 Python 并开启内置 pip 缓存 ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # 建议指定具体版本
          cache: 'pip'           # 这里开启 pip 缓存
          cache-dependency-path: 'requirements.txt'  # 明确缓存依赖文件路径

      # --- 优化点 2: 缓存 Playwright 浏览器 ---
      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright  # Playwright 在 Linux 下的默认下载路径
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: 2. 安装依赖
        run: |
          pip install -r requirements.txt

      # 只有当缓存没命中时，才去下载浏览器
      - name: Install Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: python -m playwright install --with-deps chromium

      # --- 3. 启动服务 ---
      - name: 3. 启动 Cloudflare 和 Uvicorn
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          WORKFLOW_FILE: danmu.yaml
        run: |
          # 以后台模式启动 Cloudflare
          docker run -d --network="host" cloudflare/cloudflared:latest tunnel --no-autoupdate run --token ${{secrets.CLOUDFLARE_TOKEN}}
          
          # 启动应用
          uvicorn app:app --host 0.0.0.0 --port 5173 --log-level info

      - name: Display Trigger Source
        run: echo "本任务由 ${{ github.event.inputs.reason }} 触发"